<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Sidebar</title>
        <!-- Add Font Awesome CDN -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    </head>
<body>
    <nav class="sidebar">
        <ul>
            <li><a href="/dashboard">Home</a></li>
            <li>
                <a href="javascript:void(0)" class="expandable">Transaction <span class="arrow">‚ñº</span></a>
                <ul class="submenu">
                    <li><a href="/in">In</a></li>
                    <li><a href="/out">Out</a></li>
                    <li><a href="/transfer">Transfer</a></li>
                </ul>
            </li>
            <li><a href="/adjustment">Adjustment</a></li>
            <li><a href="/alert">Alert</a></li>
            <li>
                <a href="javascript:void(0)" class="expandable">Edit <span class="arrow">‚ñº</span></a>
                <ul class="submenu">
                    <li><a href="/editHistory">History</a></li>
                    <li><a href="/editName">Name</a></li>
                </ul>
            </li>
            <li><a href="/report">Report</a></li>
            <li><a href="/profile">Profile</a></li>
            <li><a href="/logout">Logout</a></li>
        </ul>
    </nav>

    <!-- Moved topbar.ejs content here -->
    <nav class="top-bar">
        <span class="username"></span>
        <div class="icons">
            <a href="javascript:void(0)" class="icon-link" onclick="toggleNotifications()">
                <i class="fas fa-bell notification-icon"></i>
                <span id="notificationDot" class="notification-dot" style="display: none;"></span>
            </a>
            
            <div id="notificationDropdown" class="notification-dropdown">
                <p id="notificationMessage">Checking notifications...</p>
                <a id="viewAlerts" href="/reportlist/reportalert" class="btn btn-view" onclick="markAsRead()" style="display: none;">View Alerts</a>
            </div>
            
            <span class="username"><%= username %></span>
            <a href="/profile" class="icon-link">
                <i class="fa fa-user profile-icon"></i>
            </a>
            
            
        </div>
        <input type="hidden" id="userid" value="<%= userid %>">
    </nav>

    <script>
        // Ensure script runs after DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Script loaded and DOM fully parsed.');
            
            // Select all expandable links
            const expandableLinks = document.querySelectorAll('.expandable');
            console.log('Expandable links found:', expandableLinks);

            expandableLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const submenu = link.nextElementSibling;
                    const arrow = link.querySelector('.arrow');

                    // Debugging logs
                    console.log('Clicked link:', link);
                    console.log('Submenu:', submenu);

                    if (submenu.style.display === 'block') {
                        submenu.style.display = 'none'; // Collapse submenu
                        arrow.textContent = '‚ñº'; // Down arrow
                    } else {
                        submenu.style.display = 'block'; // Expand submenu
                        arrow.textContent = '‚ñ≤'; // Up arrow
                    }
                });
            });
        });
        document.addEventListener('DOMContentLoaded', () => {
            checkNotifications();
            setInterval(checkNotifications, 60000); // Auto check every 1 minute
        });

        async function checkNotifications() {
            try {
                const response = await fetch('/notification/check');
                const data = await response.json();

                const notificationMessage = document.getElementById("notificationMessage");
                const notificationDot = document.getElementById("notificationDot");
                const viewAlerts = document.getElementById("viewAlerts");

                if (data.success && data.alertCount > 0) {
                    notificationDot.style.display = "inline-block";
                    notificationMessage.innerHTML = `üîî ${data.message}`;
                    viewAlerts.style.display = "block";
                    viewAlerts.classList.remove("disabled");
                } else {
                    notificationDot.style.display = "none";
                    notificationMessage.innerHTML = "No new alerts";
                    viewAlerts.style.display = "block";
                    viewAlerts.classList.add("disabled");
                }
            } catch (error) {
                console.error("Error fetching notifications:", error);
            }
        }

        function toggleNotifications() {
            const dropdown = document.getElementById("notificationDropdown");
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";

            // Ensure dropdown stays inside the screen
            const rect = dropdown.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                dropdown.style.left = "auto";
                dropdown.style.right = "0px";
            }
        }

        async function checkNotifications() {
            try {
                const response = await fetch('/notification/check');
                const data = await response.json();

                console.log("üîî Notification Response:", data);

                const notificationMessage = document.getElementById("notificationMessage");
                const notificationDot = document.getElementById("notificationDot");
                const viewAlerts = document.getElementById("viewAlerts");

                if (data.success && data.alertCount > 0) {
                    notificationDot.style.display = "inline-block";
                    notificationMessage.innerHTML = `üîî ${data.message}`;
                    viewAlerts.style.display = "block";
                    viewAlerts.classList.remove("disabled");
                } else {
                    notificationDot.style.display = "none";
                    notificationMessage.innerHTML = "No new alerts";
                    viewAlerts.style.display = "block";
                    viewAlerts.classList.add("disabled");
                }
            } catch (error) {
                console.error("‚ùå Error fetching notifications:", error);
            }
        }


        async function markAsRead() {
            await fetch('/notification/mark-as-read', { method: 'POST' });
            document.getElementById("notificationDot").style.display = "none";
        }

    </script>
</body>
</html>